# dify 启动文档

## Docker

- 安装 docker https://docs.docker.com/engine/install/
- 安装 docker-compse https://docs.docker.com/compose/install/
- 配置 docker

```shell
# 启动docker
systemctl start docker

# 开机启动docker
systemctl enable docker

# 配置镜像源
# 镜像源参考地址  国内可用的docker源
# https://www.coderjia.cn/archives/dba3f94c-a021-468a-8ac6-e840f85867ea

vim ~/.docker/config.json
# 加入 以下配置
{
  "registry-mirrors": [
    "https://dockerpull.cn"
  ]
}

# 重启docker
systemctl daemon-reload
systemctl restart docker

# 查看docker信息
docker info
```

## github源
```shell
# 在clone完代码后
# 添加github源
git remote add github https://github.com/langgenius/dify.git
# 切换到dify分支
git checkout dify
# fetch github
git fetch github
# 设置上游分支
git branch --set-upstream-to=github/main dify
# 切回master分支
git checkout master

# master分支目前已合并github最新代码
# github最新代码在dify分支下
# 如果要合并github最新代码
git checkout dify
git pull github
git checkout master
git merge dify

# .git/config
[core]
	repositoryformatversion = 0
	filemode = true
	bare = false
	logallrefupdates = true
	ignorecase = true
	precomposeunicode = true
[remote "origin"]
	url = root@10.6.11.3:/data/git/dify.git
	fetch = +refs/heads/*:refs/remotes/origin/*
[branch "master"]
	remote = origin
	merge = refs/heads/master
[remote "github"]
	url = https://github.com/langgenius/dify.git
	fetch = +refs/heads/*:refs/remotes/github/*
[branch "dify"]
	remote = github
	merge = refs/heads/main
```
##

## api
```shell
# 1. 进入到后端目录
cd api

cp .env.example .env

# 2. 构建后端服务
docker build -t dify-api-local:1.0.0 .
```

## 前端
```shell
# nodejs版本 >= 18，推荐 >=20.18.x
# nvm use 20

cd web

cp .env.example .env

# 安装依赖
pnpm i

# 启动开发，打开http://localhost:3000
pnpm dev

# 以3001端口启动开发
# pnpm dev 3001

# 设置node最大内存
export NODE_OPTIONS="--max-old-space-size=4096"

# 构建前端代码，注意Windows下，需要以管理员身份运行
pnpm build

# 打包前端镜像
docker build -t dify-web-local:1.0.0 .
```

## 部署

```shell
cd docker

cp .env.example .env

# 打包后web默认占用80和443端口，可修改 docker/.env 里的 EXPOSE_NGINX_PORT 和 EXPOSE_NGINX_SSL_PORT
# EXPOSE_NGINX_PORT=81
# EXPOSE_NGINX_SSL_PORT=444

cp middleware.env.example middleware.env

# 启动容器
docker-compose up -d

# 修改前端代码后，重新构建
# cd web
# pnpm build
# docker build -t dify-web-local:1.0.0 .

# 更新web容器
cd docker
docker-compose up -d web

# 修改api代码后，重新构建
# cd api
# pnpm build
# docker build -t dify-api-local:1.0.0 .

# 更新api容器
cd docker
docker-compose up -d api
```

## web & api 一键构建并重启容器
```shell
./build.sh

# windows
# .\build.bat
```

## Windows 环境下注意点

- 当走完上面的流程后，打开本地的 localhost 浏览器地址后极大概率会出现：Internal Server Error 错误，此时，需要采用本地的数据库连接工具。

```shell
# 1. 连接 PostgreSQL 数据库，账号：postgres、密码：difyai123456。
# 2. 创建名为 dify 的数据库。

# 重启 db 进程
docker restart docker-db-1

# 重启 服务端
docker restart docker-api-1
```

## API 启动调试

- 在 docker docker-compose.yaml 的文件下，记录了各项依赖以及前后端服务的名称，因此在修改对应的代码文件后，可在此文件中查看对应服务名称：执行 `docker build -t [name] .` 进行重新构建

```shell
# 1. 进入到后端目录
cd api

# 2. 构建后端服务
docker build -t dify-api-local:1.0.0 .

# 3. 再次进入 docker 目录
cd docker

# 4. 重启后端服务
docker-compose up -d api
```

## 连接本地的大模型

- 在创建应用的界面，选择模型时，url 输入框内添加: http://host.docker.internal:[port], 不要填写本机的 ip 以及 本地回环地址。
